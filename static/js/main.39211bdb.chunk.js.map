{"version":3,"sources":["hooks/useStateWithCallback.js","socket/index.js","hooks/useWebRTC.js","pages/Room/index.js","pages/Main/index.js","pages/NotFound404/index.js","App.js","index.js","socket/actions.js"],"names":["useStateWithCallback","initialState","state","setState","useState","cbRef","useRef","updateState","useCallback","newState","cb","current","prev","useEffect","socket","io","reconnectionAttempts","timeout","transports","LOCAL_VIDEO","Room","id","roomID","useParams","clients","provideMediaRef","updateClients","addNewClient","newClient","list","includes","peerConnections","localMediaStream","peerMediaElements","on","ACTIONS","ADD_PEER","async","_ref","peerID","createOffer","console","warn","RTCPeerConnection","iceServers","freeice","onicecandidate","event","candidate","emit","RELAY_ICE","iceCandidate","tracksNumber","ontrack","_ref2","streams","remoteStream","srcObject","settled","interval","setInterval","clearInterval","getTracks","forEach","track","addTrack","offer","setLocalDescription","RELAY_SDP","sessionDescription","off","SESSION_DESCRIPTION","_ref3","_peerConnections$curr","remoteDescription","setRemoteDescription","RTCSessionDescription","type","answer","createAnswer","ICE_CANDIDATE","_ref4","_peerConnections$curr2","addIceCandidate","RTCIceCandidate","REMOVE_PEER","_ref5","close","filter","c","navigator","mediaDevices","getUserMedia","audio","video","width","height","localVideoElement","volume","startCapture","then","JOIN","room","catch","e","error","stop","LEAVE","node","useWebRTC","videoLayout","clientsNumber","arguments","length","undefined","pairs","Array","from","reduce","acc","next","index","arr","push","slice","map","row","flat","layout","_jsx","style","display","alignItems","justifyContent","flexWrap","children","clientID","ref","instance","autoPlay","playsInline","muted","Main","history","useHistory","rooms","updateRooms","rootNode","SHARE_ROOMS","_jsxs","onClick","v4","NotFound404","App","BrowserRouter","Switch","Route","exact","path","component","ReactDOM","render","React","StrictMode","document","getElementById","module","exports"],"mappings":"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","file":"static/js/main.39211bdb.chunk.js","sourcesContent":["import {useState, useCallback, useRef, useEffect} from 'react';\n\nconst useStateWithCallback = initialState => {\n  const [state, setState] = useState(initialState);\n  const cbRef = useRef(null);\n\n  const updateState = useCallback((newState, cb) => {\n    cbRef.current = cb;\n\n    setState(prev => typeof newState === 'function' ? newState(prev) : newState);\n  }, []);\n\n  useEffect(() => {\n    if (cbRef.current) {\n      cbRef.current(state);\n      cbRef.current = null;\n    }\n  }, [state]);\n\n  return [state, updateState];\n}\n\nexport default useStateWithCallback;","import {io} from 'socket.io-client';\n\nconst options = {\n  \"force new connection\": true,\n  reconnectionAttempts: \"Infinity\", // avoid having user reconnect manually in order to prevent dead clients after a server restart\n  timeout : 10000, // before connect_error and connect_timeout are emitted.\n  transports : [\"websocket\"]\n}\n\nconst socket = io('http://localhost:3001', options);\n\nexport default socket;\n","import {useEffect, useRef, useCallback} from 'react';\nimport freeice from 'freeice';\nimport useStateWithCallback from './useStateWithCallback';\nimport socket from '../socket';\nimport ACTIONS from '../socket/actions';\n\nexport const LOCAL_VIDEO = 'LOCAL_VIDEO';\n\n\nexport default function useWebRTC(roomID) {\n  const [clients, updateClients] = useStateWithCallback([]);\n\n  const addNewClient = useCallback((newClient, cb) => {\n    updateClients(list => {\n      if (!list.includes(newClient)) {\n        return [...list, newClient]\n      }\n\n      return list;\n    }, cb);\n  }, [clients, updateClients]);\n\n  const peerConnections = useRef({});\n  const localMediaStream = useRef(null);\n  const peerMediaElements = useRef({\n    [LOCAL_VIDEO]: null,\n  });\n\n  useEffect(() => {\n    async function handleNewPeer({peerID, createOffer}) {\n      if (peerID in peerConnections.current) {\n        return console.warn(`Already connected to peer ${peerID}`);\n      }\n\n      peerConnections.current[peerID] = new RTCPeerConnection({\n        iceServers: freeice(),\n      });\n\n      peerConnections.current[peerID].onicecandidate = event => {\n        if (event.candidate) {\n          socket.emit(ACTIONS.RELAY_ICE, {\n            peerID,\n            iceCandidate: event.candidate,\n          });\n        }\n      }\n\n      let tracksNumber = 0;\n      peerConnections.current[peerID].ontrack = ({streams: [remoteStream]}) => {\n        tracksNumber++\n\n        if (tracksNumber === 2) { // video & audio tracks received\n          tracksNumber = 0;\n          addNewClient(peerID, () => {\n            if (peerMediaElements.current[peerID]) {\n              peerMediaElements.current[peerID].srcObject = remoteStream;\n            } else {\n              // FIX LONG RENDER IN CASE OF MANY CLIENTS\n              let settled = false;\n              const interval = setInterval(() => {\n                if (peerMediaElements.current[peerID]) {\n                  peerMediaElements.current[peerID].srcObject = remoteStream;\n                  settled = true;\n                }\n\n                if (settled) {\n                  clearInterval(interval);\n                }\n              }, 1000);\n            }\n          });\n        }\n      }\n\n      localMediaStream.current.getTracks().forEach(track => {\n        peerConnections.current[peerID].addTrack(track, localMediaStream.current);\n      });\n\n      if (createOffer) {\n        const offer = await peerConnections.current[peerID].createOffer();\n\n        await peerConnections.current[peerID].setLocalDescription(offer);\n\n        socket.emit(ACTIONS.RELAY_SDP, {\n          peerID,\n          sessionDescription: offer,\n        });\n      }\n    }\n\n    socket.on(ACTIONS.ADD_PEER, handleNewPeer);\n\n    return () => {\n      socket.off(ACTIONS.ADD_PEER);\n    }\n  }, []);\n\n  useEffect(() => {\n    async function setRemoteMedia({peerID, sessionDescription: remoteDescription}) {\n      await peerConnections.current[peerID]?.setRemoteDescription(\n        new RTCSessionDescription(remoteDescription)\n      );\n\n      if (remoteDescription.type === 'offer') {\n        const answer = await peerConnections.current[peerID].createAnswer();\n\n        await peerConnections.current[peerID].setLocalDescription(answer);\n\n        socket.emit(ACTIONS.RELAY_SDP, {\n          peerID,\n          sessionDescription: answer,\n        });\n      }\n    }\n\n    socket.on(ACTIONS.SESSION_DESCRIPTION, setRemoteMedia)\n\n    return () => {\n      socket.off(ACTIONS.SESSION_DESCRIPTION);\n    }\n  }, []);\n\n  useEffect(() => {\n    socket.on(ACTIONS.ICE_CANDIDATE, ({peerID, iceCandidate}) => {\n      peerConnections.current[peerID]?.addIceCandidate(\n        new RTCIceCandidate(iceCandidate)\n      );\n    });\n\n    return () => {\n      socket.off(ACTIONS.ICE_CANDIDATE);\n    }\n  }, []);\n\n  useEffect(() => {\n    const handleRemovePeer = ({peerID}) => {\n      if (peerConnections.current[peerID]) {\n        peerConnections.current[peerID].close();\n      }\n\n      delete peerConnections.current[peerID];\n      delete peerMediaElements.current[peerID];\n\n      updateClients(list => list.filter(c => c !== peerID));\n    };\n\n    socket.on(ACTIONS.REMOVE_PEER, handleRemovePeer);\n\n    return () => {\n      socket.off(ACTIONS.REMOVE_PEER);\n    }\n  }, []);\n\n  useEffect(() => {\n    async function startCapture() {\n      localMediaStream.current = await navigator.mediaDevices.getUserMedia({\n        audio: true,\n        video: {\n          width: 1280,\n          height: 720,\n        }\n      });\n\n      addNewClient(LOCAL_VIDEO, () => {\n        const localVideoElement = peerMediaElements.current[LOCAL_VIDEO];\n\n        if (localVideoElement) {\n          localVideoElement.volume = 0;\n          localVideoElement.srcObject = localMediaStream.current;\n        }\n      });\n    }\n\n    startCapture()\n      .then(() => socket.emit(ACTIONS.JOIN, {room: roomID}))\n      .catch(e => console.error('Error getting userMedia:', e));\n\n    return () => {\n      localMediaStream.current.getTracks().forEach(track => track.stop());\n\n      socket.emit(ACTIONS.LEAVE);\n    };\n  }, [roomID]);\n\n  const provideMediaRef = useCallback((id, node) => {\n    peerMediaElements.current[id] = node;\n  }, []);\n\n  return {\n    clients,\n    provideMediaRef\n  };\n}","import {useParams} from 'react-router';\nimport useWebRTC, {LOCAL_VIDEO} from '../../hooks/useWebRTC';\n\nfunction layout(clientsNumber = 1) {\n  const pairs = Array.from({length: clientsNumber})\n    .reduce((acc, next, index, arr) => {\n      if (index % 2 === 0) {\n        acc.push(arr.slice(index, index + 2));\n      }\n\n      return acc;\n    }, []);\n\n  const rowsNumber = pairs.length;\n  const height = `${100 / rowsNumber}%`;\n\n  return pairs.map((row, index, arr) => {\n\n    if (index === arr.length - 1 && row.length === 1) {\n      return [{\n        width: '100%',\n        height,\n      }];\n    }\n\n    return row.map(() => ({\n      width: '50%',\n      height,\n    }));\n  }).flat();\n}\n\nexport default function Room() {\n  const {id: roomID} = useParams();\n  const {clients, provideMediaRef} = useWebRTC(roomID);\n  const videoLayout = layout(clients.length);\n\n  return (\n    <div style={{\n      display: 'flex',\n      alignItems: 'center',\n      justifyContent: 'center',\n      flexWrap: 'wrap',\n      height: '100vh',\n    }}>\n      {clients.map((clientID, index) => {\n        return (\n          <div key={clientID} style={videoLayout[index]} id={clientID}>\n            <video\n              width='100%'\n              height='100%'\n              ref={instance => {\n                provideMediaRef(clientID, instance);\n              }}\n              autoPlay\n              playsInline\n              muted={clientID === LOCAL_VIDEO}\n            />\n          </div>\n        );\n      })}\n    </div>\n  );\n}","import {useState, useEffect, useRef} from 'react';\nimport socket from '../../socket';\nimport ACTIONS from '../../socket/actions';\nimport {useHistory} from 'react-router';\nimport {v4} from 'uuid';\n\nexport default function Main() {\n  const history = useHistory();\n  const [rooms, updateRooms] = useState([]);\n  const rootNode = useRef();\n\n  useEffect(() => {\n    socket.on(ACTIONS.SHARE_ROOMS, ({rooms = []} = {}) => {\n      if (rootNode.current) {\n        updateRooms(rooms);\n      }\n    });\n  }, []);\n\n  return (\n    <div ref={rootNode}>\n      <h1>Available Rooms</h1>\n\n      <ul>\n        {rooms.map(roomID => (\n          <li key={roomID}>\n            {roomID}\n            <button onClick={() => {\n              history.push(`/room/${roomID}`);\n            }}>JOIN ROOM</button>\n          </li>\n        ))}\n      </ul>\n\n      <button onClick={() => {\n        history.push(`/room/${v4()}`);\n      }}>Create New Room</button>\n    </div>\n  );\n}","export default function NotFound404() {\n  return (\n    <div>\n      NOT FOUND.\n    </div>\n  );\n}","import {BrowserRouter, Switch, Route} from 'react-router-dom';\nimport Room from './pages/Room';\nimport Main from './pages/Main';\nimport NotFound404 from './pages/NotFound404';\n\nfunction App() {\n  return (\n    <BrowserRouter>\n      <Switch>\n        <Route exact path='/room/:id' component={Room}/>\n        <Route exact path='/' component={Main}/>\n        <Route component={NotFound404}/>\n      </Switch>\n    </BrowserRouter>\n  );\n}\n\nexport default App;\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\n\nReactDOM.render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n","const ACTIONS = {\n  JOIN: 'join',\n  LEAVE: 'leave',\n  SHARE_ROOMS: 'share-rooms',\n  ADD_PEER: 'add-peer',\n  REMOVE_PEER: 'remove-peer',\n  RELAY_SDP: 'relay-sdp',\n  RELAY_ICE: 'relay-ice',\n  ICE_CANDIDATE: 'ice-candidate',\n  SESSION_DESCRIPTION: 'session-description'\n};\n\nmodule.exports = ACTIONS;"],"sourceRoot":""}